#!/bin/bash

loggertitle="$(basename ${0})[$$]"

# dont do anything if process is already running
if [ $(pgrep -f ${0} | wc -l) -gt 2 ]; then
    echo "[ERR] Process of ${0} is already running"
    logger -t $loggertitle "[ERR] Process of ${0} is already running"
    exit
fi

rm -fv /root/.aws/credentials | logger -t $loggertitle
service amazon-ssm-agent restart
service awslogs restart
logger -t $loggertitle "Reloaded amazon-ssm-agent and awslogs"

# do some leftovers
CONFIG=$(cat /etc/rpi.json)
s3bucket="s3://"$(jq -r .aws.s3 <<< $CONFIG)
maindir=$(jq -r .maindir <<< $CONFIG)
wwwhtml="/var/www/html"

# take care of some failed files
find $maindir -name 'aws*.retry' -exec /etc/scripts/retry-files {} \;

# take care of timelapses
DATEDIR=`date +%Y/%m/%d`
CAM="cam1" # TODO make this dynamic from rpi.json
TMPLOCAL="$maindir/$CAM/$DATEDIR"
HOUR=$(date +"%H")

# make timelapse for yesterday
if [ $HOUR -eq 1 ]; then
    /etc/scripts/create-timelapse $CAM
fi

# move to S3 only in the hours from 1 to 5 AM
if [ $HOUR -ge 1 ] && [ $HOUR -lt 5 ] && [ -d $maindir/dailytimelapses ]; then

    find $maindir/dailytimelapses -type f -name "*.mp4" -exec \
        aws s3 mv {} $s3bucket/dailytimelapses/ --acl public-read --only-show-errors \; \
        2>&1 | logger -t $loggertitle

    if [ ${PIPESTATUS[0]} -ne 0 ]; then
        logger -t $loggertitle "[ERR] AWSCLI error code: ${PIPESTATUS[0]}"
    else
        logger -t $loggertitle "[OK] $LAPSEDIR/dailytimelapses/ files moved to S3"
        touch $LAPSEDIR/dailytimelapses/never.empty
    fi

fi

# delete old *.retry files
find /tmp -mtime +1 -type f -name "*.retry" -exec rm -vf {} \; | logger -t $loggertitle
# delete old *.jpg files
find $maindir -mtime +10 -type f -name "*.jpg" -exec rm -vf {} \; | logger -t $loggertitle
# delete old timelapses
find $maindir -mtime +20 -type f -name "*.mp4" -exec rm -vf {} \; | logger -t $loggertitle
# wipe old temporary files
find $maindir -mtime +10 -type f -name "awscli-n-logs-updated.tmp" -exec rm -vf {} \; | logger -t $loggertitle
# delete empty dirs
find $maindir -mtime +1 -mindepth 1 -type d -empty -exec rm -vrf {} \; | logger -t $loggertitle
find $wwwhtml -mtime +1 -mindepth 1 -type d -empty -exec rm -vrf {} \; | logger -t $loggertitle
